---
import { Image, getImage } from "astro:assets"
import type { ImageMetadata } from "astro"
import { imageMetadata } from "astro/assets/utils"
interface Props {
  source: string
  text?: string
}
const { source, text } = Astro.props

let imageClass = "imageitem--image"

const imageImports = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/images/projectImages/*.{jpeg,jpg,png,gif,webp}"
)
const imagePath = "/src/" + source + ".webp"
if (!imageImports[imagePath]) throw new Error("Image not found")
const imgRef = imageImports[imagePath]
const imageMetaData = await imgRef()
const image = await getImage({ src: imageMetaData.default })
const divStyle = {
    backgroundImage: `url(${image.src})`,
    backgroundSize: "cover",
    backgroundPosition: "center",
  }
let imgHeight: number
let imgWidth: number
if (image) {
  const tmpHeight = image.attributes.height
  const tmpWidth = image.attributes.width
  let heightConstrained: boolean
  const aspectRatio = tmpWidth / tmpHeight
  tmpHeight * 4 > tmpWidth * 5
    ? (heightConstrained = true)
    : (heightConstrained = false)
  if (heightConstrained) {
    imageClass = "imageitem--height"
    imgHeight = 240 
    imgWidth = 240 * aspectRatio
  } else {
    imageClass = "imageitem--width"
    imgHeight = 300 / aspectRatio
    imgWidth = 300
  }
}
---

<div class="imageitem--parent">
  <div class="imageitem--container" style={divStyle}></div>
  {
    imageImports[imagePath] ? (
      <Image 
        src={imageImports[imagePath]()}
        alt={text || ""}
        class={imageClass}
        width={imgWidth}
        height={imgHeight}
        class={imageClass}
      />
    ) : (
      []
    )
  }
</div>

<style>
  .imageitem--parent {
    position: relative;
    aspect-ratio: 5/4;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--border-radius);
    overflow:hidden;
    cursor: pointer;
  }
  
  .imageitem--image {
    position: absolute;
    top: 0px;
    left: 0px;
  }

  .imageitem--height {
    height: 100%;
    position: absolute;
    box-shadow: 0px 0px 20px 4px #0009;
  }

  .imageitem--width {
    width: 100%;
    position: absolute;
    box-shadow: 0px 0px 20px 4px #0009;
  }


  .imageitem--container {
    width: 100%;
    height: 100%;
    filter: blur(8px);
    

  }
</style>
